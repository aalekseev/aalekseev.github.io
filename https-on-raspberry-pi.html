<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Robotehnik Thoughts - HTTPS on Raspberry Pi</title>
    <link href="theme/favicon.ico" rel="icon" type="image/x-icon" />
    <link rel="stylesheet" href="theme/css/base.css">
    <link rel="stylesheet" href="theme/css/styles.css">




</head>

<body>
    <nav>
        <a href="/">Robotehnik Thoughts</a>
        <ul>
            <li><a href="/">All posts</a></li>

            <li><a href="https://github.com/aalekseev" target="_blank">GitHub</a></li>
            <li><a href="https://linkedin.com/in/aalekseev" target="_blank">LinkedIn</a></li>

        </ul>
    </nav>

<article>
    <aside>
        <figure>
            <img src="theme/img/me.jpg" alt="Photo">
            <figcaption>Anton Alekseev</figcaption>
        </figure>
        <p>
            Hi! I am a fullstack developer
            at Thorgate, Tallinn.
        </p>
    </aside>

    <h1>HTTPS on Raspberry Pi</h1>

    

    <time class="published" datetime="2018-04-24T22:12:09+03:00">Tue 24 April 2018</time>

    <p>This post is about how to set up https on a raspberry pi device, based on my recent experience</p>
<h2>Installing certbot on Raspberry Pi</h2>
<p>What helped me a lot is a discussion on this <a href="https://github.com/certbot/certbot/issues/2673#issuecomment-286276081" title="GitHub">issue</a>. And particularly a comment. In case the issue will be harder to find I'll leave it here:</p>
<ol>
<li>Uninstall all previous broken package/dependencies</li>
<li><code>add deb http://mirrordirector.raspbian.org/raspbian/ testing main contrib non-free rpi</code> to <code>/etc/apt/sources.list</code></li>
<li><code>apt-get update</code></li>
<li><code>apt-get install certbot</code></li>
</ol>
<p>For me the part with <em>updating</em> was not enough, with the installation of certbot there was a warning about incompatible packages in the system, so I <strong>upgraded</strong> and the problem was gone for good.</p>
<h2>Generate certificates</h2>
<p>To generate certificates with certbot</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo certbot certonly -a webroot --webroot-path<span class="o">=</span>/var/www/html -d example.com -d www.example.com
</pre></div>


<p>Now certbot will ask a lot of questions. After this, it prints to console <code>IMPORTANT NOTES</code> block and you can check that certs were generated by issuing this command</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo ls -l /etc/letsencrypt/live/your_domain_name
</pre></div>


<p>For even stronger security recommended generating the Diffie-Hellman group.</p>
<blockquote>
<p>This will take a reeeeeeeaaaaaaaaalllllyyyyy long time</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem <span class="m">2048</span>
</pre></div>


<h2>Configure Nginx</h2>
<p>It is recommended to create a <code>snippets</code> folder in nginx folder <code>$ mkdir /etc/nginx/snippets</code>. Here we can place reusable parts of the code that can be included in the final configuration file. Lets call this file <code>/etc/nginx/snippets/ssl-params.conf</code></p>
<div class="highlight"><pre><span></span><span class="c1"># from https://cipherli.st/</span>
<span class="c1"># and https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html</span>

<span class="k">ssl_protocols</span> <span class="s">TLSv1</span> <span class="s">TLSv1.1</span> <span class="s">TLSv1.2</span><span class="p">;</span>
<span class="k">ssl_prefer_server_ciphers</span> <span class="no">on</span><span class="p">;</span>
<span class="k">ssl_ciphers</span> <span class="s">&quot;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&quot;</span><span class="p">;</span>
<span class="k">ssl_ecdh_curve</span> <span class="s">secp384r1</span><span class="p">;</span>
<span class="k">ssl_session_cache</span> <span class="s">shared:SSL:10m</span><span class="p">;</span>
<span class="k">ssl_session_tickets</span> <span class="no">off</span><span class="p">;</span>
<span class="k">ssl_stapling</span> <span class="no">on</span><span class="p">;</span>
<span class="k">ssl_stapling_verify</span> <span class="no">on</span><span class="p">;</span>
<span class="k">resolver</span> <span class="mi">8</span><span class="s">.8.8.8</span> <span class="mi">8</span><span class="s">.8.4.4</span> <span class="s">valid=300s</span><span class="p">;</span>
<span class="k">resolver_timeout</span> <span class="s">5s</span><span class="p">;</span>
<span class="c1"># Disable preloading HSTS for now.  You can use the commented out header line that includes</span>
<span class="c1"># the &quot;preload&quot; directive if you understand the implications.</span>
<span class="c1"># add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot;;</span>
<span class="k">add_header</span> <span class="s">Strict-Transport-Security</span> <span class="s">&quot;max-age=63072000</span><span class="p">;</span> <span class="k">includeSubdomains&quot;</span><span class="p">;</span>
<span class="k">add_header</span> <span class="s">X-Frame-Options</span> <span class="s">DENY</span><span class="p">;</span>
<span class="k">add_header</span> <span class="s">X-Content-Type-Options</span> <span class="s">nosniff</span><span class="p">;</span>

<span class="c1"># ssl_dhparam /etc/ssl/certs/dhparam.pem;</span>
</pre></div>


<blockquote>
<p>Uncomment the last line if you generated Diffie-Hellman group from the previous section.</p>
</blockquote>
<p>Next, for purpose of this tutorial we'll edit the default nginx configuration file <code>/etc/nginx/sites-available/default</code>. But before, let's backup this file <code>cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak</code></p>
<p>This config will be in two parts - first: redirect all traffic from HTTP to HTTPS</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:80</span> <span class="s">default_server</span><span class="p">;</span>

    <span class="kn">server_name</span> <span class="s">example.com</span> <span class="s">www.example.com</span><span class="p">;</span>
    <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>The second block is about actual SSL configuration</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:443</span> <span class="s">ssl</span> <span class="s">default_server</span><span class="p">;</span>

    <span class="kn">ssl_certificate</span> <span class="s">/etc/letsencrypt/live/example.com/fullchain.pem</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="s">/etc/letsencrypt/live/example.com/privkey.pem</span><span class="p">;</span>

    <span class="kn">include</span> <span class="s">snippets/ssl-params.conf</span><span class="p">;</span>

    <span class="kn">root</span> <span class="s">/var/www/html</span><span class="p">;</span>
    <span class="kn">index</span> <span class="s">index.html</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri/</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Above is a complete config for a static site with <code>index.html</code> entry point that located in <code>/var/www/html</code></p>
<p>Now, let's check nginx configuration file</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo nginx -t
</pre></div>


<p>Reload Nginx config after making changes</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo service nginx reload
</pre></div>


<h2>Certificate auto-renewal</h2>
<p>Letsenscript certifictes only last for 90 days, so it is recommended to renew certificates once in a while. A great tool for such tasks will be cron task manager that available without installation on many Unix systems by default.</p>
<p>To edit tasks list</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo crontab -e
</pre></div>


<p>Add this line to file</p>
<div class="highlight"><pre><span></span>30 2 * * * /usr/bin/certbot renew --noninteractive --renew-hook &quot;/bin/systemctl reload nginx&quot; &gt;&gt; /var/log/le-renew.log
</pre></div>


<p>Be careful, every user in a system have their own tasks list!</p>
<h2>The Last</h2>
<p>Some tips if you encounter any errors:</p>
<ul>
<li>Be sure to check that router from where raspberry gets internet access have open connections for port <code>443</code></li>
<li>If nginx warns that it can't bind to port <code>80</code>, look at who is listening to that port with <code>$ netstat -tunapl | grep 80</code>. I read that sometimes there was installed apache and they conflict with each other.</li>
</ul>
<p>Great resource to check your site SSL certificate score is here - <a href="https://www.ssllabs.com/ssltest/analyze.html?d=example.com">SSL Online Analyzer Tool</a></p>
<p>This article is greatly inspired by this, more in-depth publication from digitalocean <a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-debian-8" title="Digital Ocean tutorial">Let's Enscript on Debian 8</a></p>
<h2>The Last Last</h2>
<p>This is some badass sites about HTTPS and DNS</p>
<ul>
<li><a href="https://howDNS.works" title="Animated comix explanation">How DNS works</a></li>
<li><a href="https://howHTTPS.works" title="Animated comix explanation">How HTTPS works</a></li>
</ul>

</article>

    <footer>
        <p>Anton Alekseev (c) 2019, powered by <a href="http://getpelican.com/">Pelican</a>.</p>
    </footer>
    </body>
</html>